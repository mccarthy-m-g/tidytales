<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael McCarthy">
<meta name="dcterms.date" content="2023-03-10">
<meta name="description" content="Time to events.">

<title>Tidy Tales - Survival Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../series/2023-02-24_frequentist-statistics-labs/posts/01_probability-distributions/index.html" rel="prev">
<link href="../../../../assets/images/favicon.png" rel="icon" type="image/png">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<link href="../../../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="../../../../assets/styles.css">
<meta property="og:title" content="Tidy Tales">
<meta property="og:description" content="Wrangling, Visualizing, Modelling, Communicating data">
<meta property="og:image" content="https://tidytales.ca/assets/images/twittercard.png">
<meta property="og:site-name" content="Tidy Tales">
<meta property="og:image:height" content="600">
<meta property="og:image:width" content="600">
<meta name="twitter:title" content="Tidy Tales">
<meta name="twitter:description" content="Wrangling, Visualizing, Modelling, Communicating data">
<meta name="twitter:image" content="https://tidytales.ca/assets/images/twittercard.png">
<meta name="twitter:creator" content="@mccarthymg">
<meta name="twitter:site" content="@propertidytales">
<meta name="twitter:card" content="summary">
<meta name="twitter:image-height" content="600">
<meta name="twitter:image-width" content="600">
</head>

<body class="nav-sidebar floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../../assets/images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Tidy Tales</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../#posts">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../#series">
 <span class="menu-text">Series</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../#code-snippets">
 <span class="menu-text">Snippets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../about/index.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/propertidytales"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mccarthy-m-g/tidytales"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://michaelmccarthy.tidytales.ca"><i class="bi bi-person-circle" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../../index.xml"><i class="bi bi-rss-fill" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Survival Analysis</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">Survival Analysis</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
                  <div>
        <div class="description">
          Time to events.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Michael McCarthy </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 10, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../series/2023-02-24_frequentist-statistics-labs/index.html" class="sidebar-item-text sidebar-link">Frequentist Statistics Labs</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">In this series</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../series/2023-02-24_frequentist-statistics-labs/posts/01_descriptive-statistics/index.html" class="sidebar-item-text sidebar-link">Descriptive statistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../series/2023-02-24_frequentist-statistics-labs/posts/01_probability-distributions/index.html" class="sidebar-item-text sidebar-link">Probability distributions</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../series/2023-02-24_frequentist-statistics-labs/posts/99_survival-analysis/index.html" class="sidebar-item-text sidebar-link active">Survival Analysis</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this post</h2>
   
  <ul>
  <li><a href="#recommended-reading" id="toc-recommended-reading" class="nav-link active" data-scroll-target="#recommended-reading">Recommended Reading</a></li>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a>
  <ul>
  <li><a href="#censoring" id="toc-censoring" class="nav-link" data-scroll-target="#censoring">Censoring</a></li>
  <li><a href="#hazard-and-survival-functions" id="toc-hazard-and-survival-functions" class="nav-link" data-scroll-target="#hazard-and-survival-functions">Hazard and Survival functions</a></li>
  </ul></li>
  <li><a href="#rct-veterans-administration-lung-cancer-study" id="toc-rct-veterans-administration-lung-cancer-study" class="nav-link" data-scroll-target="#rct-veterans-administration-lung-cancer-study">RCT: Veterans’ Administration Lung Cancer study</a>
  <ul>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory data analysis</a>
  <ul class="collapse">
  <li><a href="#event-history" id="toc-event-history" class="nav-link" data-scroll-target="#event-history">Event history</a></li>
  <li><a href="#survival-curves" id="toc-survival-curves" class="nav-link" data-scroll-target="#survival-curves">Survival curves</a></li>
  <li><a href="#cumulative-risk-incidence-curves" id="toc-cumulative-risk-incidence-curves" class="nav-link" data-scroll-target="#cumulative-risk-incidence-curves">Cumulative risk (incidence) curves</a></li>
  <li><a href="#cumulative-hazard-curves" id="toc-cumulative-hazard-curves" class="nav-link" data-scroll-target="#cumulative-hazard-curves">Cumulative hazard curves</a></li>
  <li><a href="#kernel-smoothed-hazard-curves" id="toc-kernel-smoothed-hazard-curves" class="nav-link" data-scroll-target="#kernel-smoothed-hazard-curves">Kernel smoothed hazard curves</a></li>
  </ul></li>
  <li><a href="#statistical-modelling" id="toc-statistical-modelling" class="nav-link" data-scroll-target="#statistical-modelling">Statistical modelling</a></li>
  <li><a href="#predictive-methods" id="toc-predictive-methods" class="nav-link" data-scroll-target="#predictive-methods">Predictive methods</a></li>
  </ul></li>
  <li><a href="#multiple-groups" id="toc-multiple-groups" class="nav-link" data-scroll-target="#multiple-groups">Multiple groups</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<section id="recommended-reading" class="level2">
<h2 class="anchored" data-anchor-id="recommended-reading">Recommended Reading</h2>
<ul>
<li><a href="http://link.springer.com/10.1007/978-3-319-31245-3">Applied Survival Analysis Using R</a> by Dirk F. Moore</li>
<li>Chapters 9 to 15 in <a href="https://doi.org/10.1093/acprof:oso/9780195152968.001.0001">Applied Longitudinal Data Analysis: Modeling Change and Event Occurrence</a> by Judith Singer and John Willett</li>
<li><a href="https://cran.r-project.org/web/packages/survival/vignettes/survival.pdf">A package for survival analysis in R</a> by Terry Therneau</li>
</ul>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(asaur)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<blockquote class="blockquote">
<p>Survival analysis is the study of survival times and of the factors that influence them.</p>
</blockquote>
<section id="censoring" class="level3">
<h3 class="anchored" data-anchor-id="censoring">Censoring</h3>
<p>There are X types of censoring:</p>
<ul>
<li>Left censoring</li>
<li>Right censoring</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>id, <span class="sc">~</span>time, <span class="sc">~</span>event, <span class="sc">~</span>censored,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p1"</span>, <span class="dv">0</span>, <span class="st">"0"</span>, <span class="cn">FALSE</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p1"</span>, <span class="dv">7</span>, <span class="st">"1"</span>, <span class="cn">TRUE</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p2"</span>, <span class="dv">0</span>, <span class="st">"0"</span>, <span class="cn">FALSE</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p2"</span>, <span class="dv">6</span>, <span class="st">"2"</span>, <span class="cn">FALSE</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> id)) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> event, <span class="at">fill =</span> censored), <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">16</span>, <span class="dv">21</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"white"</span>)) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Censoring mechanisms can be classified into three types:</p>
<ul>
<li>Type I: censoring times are pre-specified.</li>
<li>Type II: censoring occurs when a prespecified fraction of observations have failed.</li>
<li>Random: censoring occurs randomly.</li>
</ul>
</section>
<section id="hazard-and-survival-functions" class="level3">
<h3 class="anchored" data-anchor-id="hazard-and-survival-functions">Hazard and Survival functions</h3>
<blockquote class="blockquote">
<p>Survival analysis methods depend on the survival distribution, and two key ways of specifying it are the survival function and the hazard function.</p>
</blockquote>
<ul>
<li>Survival function: the probability of surviving up to a point <span class="math inline">t</span>.</li>
<li>Hazard function: the instantaneous failure rate.</li>
</ul>
<p>Survival distributions can also be represented with:</p>
<ul>
<li>Cumulative risk function: the probability of surviving on or before a point <span class="math inline">t</span>.</li>
<li>Cumulative hazard function: the area under the hazard function up to time <span class="math inline">t</span>.</li>
</ul>
<p>Survival functions are typically estimated with nonparametric methods:</p>
<ul>
<li>Kaplan-Meier estimator</li>
<li>Nelson-Altschuler estimator</li>
</ul>
</section>
</section>
<section id="rct-veterans-administration-lung-cancer-study" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="rct-veterans-administration-lung-cancer-study">RCT: Veterans’ Administration Lung Cancer study</h2>
<p>Veterans’ Administration Lung Cancer study is a standard randomized clinical trial investigating the effect of a standard or test chemotherapy on time to death in 137 males with advanced inoperable lung cancer. The data for this trial comes from kalbfleischprentice_StatisticalAnalysisFailure_2002 and is included in the survival package as <code>veteran</code>. The following variables were recorded at intake:</p>
<ul>
<li><code>trt</code>: Chemotherapy treatment type (1 = standard, 2 = test)</li>
<li><code>celltype</code>: Histological tumour type (1 = squamous, 2 = smallcell, 3 = adeno, 4 = large)</li>
<li><code>karno</code>: General medical status measured with the Karnofsky performance score (10-30 = completely hospitalized, 40-60 = partial confinement, 70-90 = able to care for self)</li>
<li><code>diagtime</code>: Time in months from diagnosis to randomization</li>
<li><code>age</code>: Age in years</li>
<li><code>prior</code>: Prior therapy (0 = no, 10 = yes)</li>
</ul>
<p>Survival was recorded as:</p>
<ul>
<li><code>time</code>: Survival time in days</li>
<li><code>status</code>: Censoring status (0 = yes, 1 = no)</li>
</ul>
<p>We can get a glimpse of the data with <code>dplyr::glimpse()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veteran)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 137
#&gt; Columns: 8
#&gt; $ trt      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
#&gt; $ celltype &lt;fct&gt; squamous, squamous, squamous, squamous, squamous, squamous, s…
#&gt; $ time     &lt;dbl&gt; 72, 411, 228, 126, 118, 10, 82, 110, 314, 100, 42, 8, 144, 25…
#&gt; $ status   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0…
#&gt; $ karno    &lt;dbl&gt; 60, 70, 60, 60, 70, 20, 40, 80, 50, 70, 60, 40, 30, 80, 70, 6…
#&gt; $ diagtime &lt;dbl&gt; 7, 5, 3, 9, 11, 5, 10, 29, 18, 6, 4, 58, 4, 9, 11, 3, 9, 2, 4…
#&gt; $ age      &lt;dbl&gt; 69, 64, 38, 63, 65, 49, 69, 68, 43, 70, 81, 63, 63, 52, 48, 6…
#&gt; $ prior    &lt;dbl&gt; 0, 10, 0, 10, 10, 0, 10, 0, 0, 0, 0, 10, 0, 10, 10, 0, 0, 0, …</code></pre>
</div>
</div>
<section id="exploratory-data-analysis" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory data analysis</h3>
<p>Rather than working with the raw data, we begin by estimating the survival function of the <code>veteran</code> data using the <strong>Kaplan-Meier estimator</strong>. We accomplish this with <code>survival::survfit()</code>, which estimates a survival curve for censored data using R’s formula syntax. The response variable is a <code>Surv</code> object created with <code>survival::Surv()</code>, which tracks survival time and censoring; the predictor is <code>1</code>, which indicates this is an intercept-only model.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>To use alternative estimators for the survival function, specify the optional <code>stype</code> and <code>ctype</code> arguments in <code>survival::survfit()</code>. For the Nelson-Aalen estimator (aka Nelson-Altschuler or Fleming-Harrington) use <code>survfit(..., stype = 2, ctype = 1)</code>; for the “fh2” estimator use <code>survfit(..., stype = 2, ctype = 2)</code>. The default Kaplan-Meier estimator is equivalent to <code>survfit(..., stype = 1, ctype = 1)</code>.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>veterans_km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> veteran)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Although we are interested in the survival function of the <code>veteran</code> data, the actual reason we began this way is because it provides a convenient method for transforming the raw data into a format better suited for some initial exploratory data analysis. We first add a time 0 to the <code>survfit</code> object with <code>survival::survfit0()</code> (otherwise the data will start at the first observation time) then get the transformed data with <code>broom::tidy()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_tidy <span class="ot">&lt;-</span> veterans_km_fit <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit0</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_km_fit_tidy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 102
#&gt; Columns: 8
#&gt; $ time      &lt;dbl&gt; 0, 1, 2, 3, 4, 7, 8, 10, 11, 12, 13, 15, 16, 18, 19, 20, 21,…
#&gt; $ n.risk    &lt;dbl&gt; 137, 137, 135, 134, 133, 132, 129, 125, 123, 122, 120, 118, …
#&gt; $ n.event   &lt;dbl&gt; 0, 2, 1, 1, 1, 3, 4, 2, 1, 2, 2, 2, 1, 3, 2, 2, 2, 1, 2, 3, …
#&gt; $ n.censor  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, …
#&gt; $ estimate  &lt;dbl&gt; 1.0000000, 0.9854015, 0.9781022, 0.9708029, 0.9635036, 0.941…
#&gt; $ std.error &lt;dbl&gt; 0.00000000, 0.01039891, 0.01278345, 0.01481644, 0.01662791, …
#&gt; $ conf.high &lt;dbl&gt; 1.0000000, 1.0000000, 1.0000000, 0.9994081, 0.9954216, 0.981…
#&gt; $ conf.low  &lt;dbl&gt; 1.0000000, 0.9655208, 0.9539002, 0.9430165, 0.9326091, 0.903…</code></pre>
</div>
</div>
<p>This summary of the <code>veteran</code> data, called a <strong>life table</strong> [see Section 10.1 in singerwillett_AppliedLongitudinalData_2003], tracks the event histories (the “lives”) of the sample from the beginning of time (when no one has experienced the target event) to the end of data collection (when everyone has either experienced the target event or been censored). For now we are only interested in first four variables, which we can use to explore event occurrence over time:</p>
<ul>
<li><code>time</code>: the time point, <span class="math inline">t</span></li>
<li><code>n.risk</code>: the number of males at risk at time <span class="math inline">t</span></li>
<li><code>n.event</code>: the number of events that occurred at time <span class="math inline">t</span></li>
<li><code>n.censor</code>: the number of males who exited the risk set, without an event, at time <span class="math inline">t</span></li>
</ul>
<p>There are two ways to visualize this data: First, we can explore how the risk set changes over time, and second, we can explore what events occurred at each time <span class="math inline">t</span>. Additionally, these visualizations can either be stepped or not; we’ll visualize both versions for completeness sake.</p>
<section id="event-history" class="level4">
<h4 class="anchored" data-anchor-id="event-history">Event history</h4>
<p>We’ll start by exploring how the risk set changes over time. This requires further transformation of the data to (1) get the appropriate counts at each time point, (2) pivot to a tidier format, and (3) create steps for each time point.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>veterans_risk_set <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (1) Get the appropriate counts at each time point.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">alive =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dead =</span> <span class="fu">cumsum</span>(n.event),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">cumsum</span>(n.censor)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, alive, dead, censored) <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (2) Pivot to a tidier format.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"status"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"dead"</span>, <span class="st">"alive"</span>)))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_risk_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 306
#&gt; Columns: 3
#&gt; $ time   &lt;dbl&gt; 0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 7, 7, 7, 8, 8, 8, …
#&gt; $ status &lt;fct&gt; alive, dead, censored, alive, dead, censored, alive, dead, cens…
#&gt; $ n      &lt;dbl&gt; 137, 0, 0, 135, 2, 0, 134, 3, 0, 133, 4, 0, 132, 5, 0, 129, 8, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (3) Create steps for each time point.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>veterans_risk_set_stepped <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">alive =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">died =</span> alive <span class="sc">+</span> <span class="fu">cumsum</span>(n.event),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> died <span class="sc">+</span> <span class="fu">cumsum</span>(n.censor)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, alive, died, censored) <span class="sc">|&gt;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"status"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"died"</span>, <span class="st">"alive"</span>)))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on: https://stackoverflow.com/a/41962072/16844576</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>veterans_risk_set_stepped <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw =</span> veterans_risk_set_stepped,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="fu">mutate</span>(veterans_risk_set_stepped, <span class="at">n =</span> <span class="fu">lag</span>(n, <span class="fu">nlevels</span>(status))),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"source"</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(time, <span class="fu">desc</span>(source))</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_risk_set_stepped)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 612
#&gt; Columns: 4
#&gt; $ source &lt;chr&gt; "step", "step", "step", "raw", "raw", "raw", "step", "step", "s…
#&gt; $ time   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, …
#&gt; $ status &lt;fct&gt; alive, died, censored, alive, died, censored, alive, died, cens…
#&gt; $ n      &lt;dbl&gt; NA, NA, NA, 137, 137, 137, 137, 137, 137, 135, 137, 137, 135, 1…</code></pre>
</div>
</div>
<p><a href="#fig-veteran-risk-set">Figure&nbsp;1</a> depicts how the risk set of the <code>veteran</code> data changed over time. This is a standard event history for survival data…</p>
<p>The advantage of the stepped version is that it makes it easier to see when events occurred. It also matches the survival curve plots we’ll create later, which are all visualized with step functions. The disadvantage is that it involves more code. If this was going to be reported to others I would use the stepped version, but for personal exploration I would use the not stepped version.</p>
<div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_risk_set, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> status)) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_risk_set_stepped, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> status)) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> n)) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-veteran-risk-set" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-veteran-risk-set-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-risk-set-1.png" class="img-fluid figure-img" data-ref-parent="fig-veteran-risk-set" width="672"></p>
<p></p><figcaption class="figure-caption">(a) Not stepped</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-veteran-risk-set-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-risk-set-2.png" class="img-fluid figure-img" data-ref-parent="fig-veteran-risk-set" width="672"></p>
<p></p><figcaption class="figure-caption">(b) Stepped</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Event history of the <code>veteran</code> data, depicting how the risk set changes over time.</figcaption><p></p>
</figure>
</div>
</div>
<p>As a compliment to <a href="#fig-veteran-risk-set">Figure&nbsp;1</a>, we can also explore what events occurred at each time <span class="math inline">t</span>. <a href="#fig-veteran-events">Figure&nbsp;2</a> depicts the event history of the <code>veteran</code> data over time—this is essentially a more information rich version of <a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_risktable.html">risk tables</a> that are sometimes appended to survival curve plots.</p>
<p>The code for this is nearly identical to the code for the previous plots—the main difference is how we calculate the counts at each time point—so I’ve folded it here.</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>veterans_events <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (1) Get the appropriate counts at each time point. Now we use the raw counts</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rather than cumulative sums.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">none =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">died =</span> n.event,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> n.censor</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, none, died, censored) <span class="sc">|&gt;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (2) Pivot to a tidier format.</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"event"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">factor</span>(event, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"died"</span>, <span class="st">"none"</span>)))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># (3) Create steps for each time point.</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>veterans_events_stepped <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">none =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">died =</span> none <span class="sc">+</span> n.event,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> died <span class="sc">+</span> n.censor</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, none, died, censored) <span class="sc">|&gt;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"event"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">factor</span>(event, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"died"</span>, <span class="st">"none"</span>)))</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>veterans_events_stepped <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw =</span> veterans_events_stepped,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="fu">mutate</span>(veterans_events_stepped, <span class="at">n =</span> <span class="fu">lag</span>(n, <span class="fu">nlevels</span>(event))),</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"source"</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(time, <span class="fu">desc</span>(source))</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_events, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> event)) <span class="sc">+</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_events_stepped, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> event)) <span class="sc">+</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> n)) <span class="sc">+</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-veteran-events" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-veteran-events-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-events-1.png" class="img-fluid figure-img" data-ref-parent="fig-veteran-events" width="672"></p>
<p></p><figcaption class="figure-caption">(a) Not stepped</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-veteran-events-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-events-2.png" class="img-fluid figure-img" data-ref-parent="fig-veteran-events" width="672"></p>
<p></p><figcaption class="figure-caption">(b) Stepped</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Event history of the <code>veteran</code> data, depicting what events occurred at each time <span class="math inline">t</span>.</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="survival-curves" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="survival-curves">Survival curves</h4>
<p>Now we’re ready to explore the Kaplan-Meier estimates of the survival probability over time. First, let’s look at the life table data again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_km_fit_tidy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 102
#&gt; Columns: 8
#&gt; $ time      &lt;dbl&gt; 0, 1, 2, 3, 4, 7, 8, 10, 11, 12, 13, 15, 16, 18, 19, 20, 21,…
#&gt; $ n.risk    &lt;dbl&gt; 137, 137, 135, 134, 133, 132, 129, 125, 123, 122, 120, 118, …
#&gt; $ n.event   &lt;dbl&gt; 0, 2, 1, 1, 1, 3, 4, 2, 1, 2, 2, 2, 1, 3, 2, 2, 2, 1, 2, 3, …
#&gt; $ n.censor  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, …
#&gt; $ estimate  &lt;dbl&gt; 1.0000000, 0.9854015, 0.9781022, 0.9708029, 0.9635036, 0.941…
#&gt; $ std.error &lt;dbl&gt; 0.00000000, 0.01039891, 0.01278345, 0.01481644, 0.01662791, …
#&gt; $ conf.high &lt;dbl&gt; 1.0000000, 1.0000000, 1.0000000, 0.9994081, 0.9954216, 0.981…
#&gt; $ conf.low  &lt;dbl&gt; 1.0000000, 0.9655208, 0.9539002, 0.9430165, 0.9326091, 0.903…</code></pre>
</div>
</div>
<p>The last four variables, which we skipped over earlier, are the Kaplan-Meier estimates of the survival probability over time:</p>
<ul>
<li><code>estimate</code>: Estimate of the survival function, the probability of surviving up to time <span class="math inline">t</span></li>
<li><code>std.error</code>: The standard error of the regression term</li>
<li><code>conf.high</code>: Upper bound on the pointwise confidence interval for the estimate</li>
<li><code>conf.low</code>: Lower bound on the pointwise confidence interval for the estimate</li>
</ul>
<p>These estimates and their intervals can be plotted as a <strong>survival curve</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_tidy,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To better visualize uncertainty about our estimates, we can plot multiple intervals of different widths. To do this we first create a small helper function, <code>dist_tidy()</code>, to get multiple intervals from a survival model with additional <code>.width</code> and <code>level</code> columns for compatibility with <code>ggdist::geom_lineribbon()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dist_tidy <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">conf.type =</span> <span class="st">"log-log"</span>, <span class="at">conf.int =</span> <span class="fl">0.95</span>, ...) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map_df</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">set_names</span>(conf.int),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(.x) broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="fu">update</span>(x, <span class="at">conf.type =</span> conf.type, <span class="at">conf.int =</span> .x)),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">.id =</span> <span class="st">".width"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggdist automatically pulls from the .width column of summarized data to</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot multiple intervals. The width column should be numeric for this to</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># work correctly.</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.width =</span> <span class="fu">as.numeric</span>(.width),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggdist turns .width into level internally with its stat_ geoms, but for</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_ geoms we need to do this in the summary data. This is mainly for</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ease of use with the fill_ramp aesthetic.</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">level  =</span> <span class="fu">factor</span>(.width, <span class="at">levels =</span> <span class="fu">sort</span>(conf.int, <span class="at">decreasing =</span> <span class="cn">TRUE</span>))</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(.width, level, <span class="at">.after =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The last time always has NAs for the CIs and it's important to remove this;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># otherwise the fills in ggdist::geom_lineribbon() will plot incorrectly.</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can plot the survival curve with multiple intervals (here 66% and 95%) using the data tidied with <code>dist_tidy()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_dist <span class="ot">&lt;-</span> <span class="fu">dist_tidy</span>(veterans_km_fit, <span class="at">conf.int =</span> <span class="fu">c</span>(<span class="fl">0.66</span>, <span class="fl">0.95</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_dist,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>p_veterans_km</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-veteran-km-curve" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-km-curve-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Kaplan-Meier survival curve with 66% and 95% intervals</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>It may also be desirable to add additional info to the survival curve plot, like when censoring occurred. A non-invasive way to do this is to add a rug of censored times to the x-axis. A more common approach is to add points directly on the survival curve where censored events occurred. These points are often plotted as black “+” signs, which can be hard to see; here I plot them as red points instead.</p>
<div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To add censoring information to the plot we need a data frame containing only</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the censored observations.</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_tidy_censored <span class="ot">&lt;-</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(veterans_km_fit_tidy, n.censor <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># With a rug</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rug</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="cn">NULL</span>), <span class="at">data =</span> veterans_km_fit_tidy_censored)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># With points</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_tidy_censored,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"red"</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-veteran-censored" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-veteran-censored-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-censored-1.png" class="img-fluid figure-img" data-ref-parent="fig-veteran-censored" width="672"></p>
<p></p><figcaption class="figure-caption">(a) Rug</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-veteran-censored-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-veteran-censored-2.png" class="img-fluid figure-img" data-ref-parent="fig-veteran-censored" width="672"></p>
<p></p><figcaption class="figure-caption">(b) Points</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4: Censoring times in the <code>veteran</code> data.</figcaption><p></p>
</figure>
</div>
</div>
<p>Along with the life table data, which we use to plot the survival curve, the <code>survfit</code> object stores the following summary statistics:</p>
<ul>
<li><code>records</code>: Number of observations</li>
<li><code>n.max</code>: Maximum number of subjects at risk</li>
<li><code>n.start</code>: Initial number of subjects at risk</li>
<li><code>events</code>: Number of events</li>
<li><code>rmean</code>: Restricted mean survival</li>
<li><code>rmean.std.error</code>: Restricted mean standard error</li>
<li><code>median</code>: Median survival</li>
<li><code>conf.low</code>: Lower end of confidence interval on median</li>
<li><code>conf.high</code>: Upper end of confidence interval on median</li>
<li><code>nobs</code>: Number of observations used</li>
</ul>
<p>They can be retrieved with <code>broom::glance()</code>:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The method used to resolve the restricted mean survival estimate when the last observation is not a death can be set with the optional <code>rmean</code> argument in <code>broom::glance()</code>. For details, see <code>?survival::print.survfit</code> and <code>?broom::glance.survfit</code>.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_summary <span class="ot">&lt;-</span> <span class="fu">glance</span>(veterans_km_fit)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_km_fit_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 1
#&gt; Columns: 10
#&gt; $ records         &lt;dbl&gt; 137
#&gt; $ n.max           &lt;dbl&gt; 137
#&gt; $ n.start         &lt;dbl&gt; 137
#&gt; $ events          &lt;dbl&gt; 128
#&gt; $ rmean           &lt;dbl&gt; 132.7768
#&gt; $ rmean.std.error &lt;dbl&gt; 15.30789
#&gt; $ median          &lt;dbl&gt; 80
#&gt; $ conf.low        &lt;dbl&gt; 52
#&gt; $ conf.high       &lt;dbl&gt; 105
#&gt; $ nobs            &lt;int&gt; 137</code></pre>
</div>
</div>
<p>These summary statistics can be included in the survival curve plot as well. For example, the <strong>median survival time</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">xend =</span> conf.high, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">yend =</span> <span class="fl">0.5</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_summary,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="fl">0.5</span>),</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_summary,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> median, <span class="at">xend =</span> median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> <span class="fl">0.5</span>),</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_summary,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="cumulative-risk-incidence-curves" class="level4">
<h4 class="anchored" data-anchor-id="cumulative-risk-incidence-curves">Cumulative risk (incidence) curves</h4>
<p>The <strong>cumulative risk</strong> (aka cumulative incidence) at a time point is simply one minus the survival probability:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>p_veterans_risk <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_dist,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> <span class="dv">1</span> <span class="sc">-</span> estimate, <span class="at">ymin =</span> <span class="dv">1</span> <span class="sc">-</span> conf.low, <span class="at">ymax =</span> <span class="dv">1</span> <span class="sc">-</span> conf.high)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>p_veterans_risk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="cumulative-hazard-curves" class="level4">
<h4 class="anchored" data-anchor-id="cumulative-hazard-curves">Cumulative hazard curves</h4>
<p>The cumulative hazard function can be estimated in two ways:</p>
<ul>
<li>the negative log survivor function method</li>
<li>the Nelson-Aalen method</li>
</ul>
<p>In general both methods give similar estimates, particularly at early event times when the risk set is large. However, they tend to diverge as the size of the risk set decreases.</p>
<p>The negative log survivor function method involves transforming the Kaplan-Meier estimates of survival probability over time by taking their negative log. The resulting estimates of the cumulative hazard function are called <strong>negative log survivor function estimates</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>p_veterans_cumhaz <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_dist,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log</span>(estimate), <span class="at">ymin =</span> <span class="sc">-</span><span class="fu">log</span>(conf.low), <span class="at">ymax =</span> <span class="sc">-</span><span class="fu">log</span>(conf.high))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"vh"</span>) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>p_veterans_cumhaz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Estimates of the cumulative hazard function and their standard error using the Nelson-Aalen method are included in the <code>survfit</code> object as <code>object$cumhaz</code> and <code>object$std.chaz</code>, respectively. No confidence intervals are returned, however.</p>
</section>
<section id="kernel-smoothed-hazard-curves" class="level4">
<h4 class="anchored" data-anchor-id="kernel-smoothed-hazard-curves">Kernel smoothed hazard curves</h4>
<p>The <strong>muhaz</strong> package provides a method for gettinng kernel smoothed estimates of the hazard function. The function API isn’t great, so we wrap it in a small helper function to make things cleaner. No intervals are provided for these estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(muhaz)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>haz_tidy <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(survival<span class="sc">::</span><span class="fu">survfit0</span>(x))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  haz <span class="ot">&lt;-</span> muhaz<span class="sc">::</span><span class="fu">muhaz</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> x<span class="sc">$</span>time,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta =</span> x<span class="sc">$</span>n.censor,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.time =</span> <span class="fu">min</span>(x<span class="sc">$</span>time),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fu">max</span>(x<span class="sc">$</span>time),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">bw.method =</span> <span class="st">"global"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">b.cor =</span> <span class="st">"none"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(haz)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">haz_tidy</span>(veterans_km_fit), <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="statistical-modelling" class="level3">
<h3 class="anchored" data-anchor-id="statistical-modelling">Statistical modelling</h3>
</section>
<section id="predictive-methods" class="level3">
<h3 class="anchored" data-anchor-id="predictive-methods">Predictive methods</h3>
</section>
</section>
<section id="multiple-groups" class="level2">
<h2 class="anchored" data-anchor-id="multiple-groups">Multiple groups</h2>
<p>TODO: Decide whether to have a single arm trial section AND a multi-group RCT section (mainly because there are some code differences between the two)</p>
<p>Multiple survival curves on one plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>veterans_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt, <span class="at">data =</span> veteran)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>veterans_fit_tidy <span class="ot">&lt;-</span> <span class="fu">dist_tidy</span>(veterans_fit, <span class="at">conf.int =</span> <span class="fu">c</span>(<span class="fl">0.66</span>, <span class="fl">0.95</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  veterans_fit_tidy,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> strata)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="fu">aes</span>(<span class="at">fill_ramp =</span> level), <span class="at">step =</span> <span class="st">"hv"</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This specific example might be better server with a faceted plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(strata), <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><code>glance()</code> only supports models that can be summarized in a single row. We can refit the survival model to subsets as a workaround to get <code>glance()</code> to work for multi-strata survival models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>veterans_fit_glance <span class="ot">&lt;-</span> <span class="fu">map_df</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"trt=1"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"trt=2"</span> <span class="ot">=</span> <span class="dv">2</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(.x) <span class="fu">glance</span>(<span class="fu">update</span>(veterans_fit, <span class="at">subset =</span> (trt <span class="sc">==</span> .x))),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"strata"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>veterans_fit_glance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["strata"],"name":[1],"type":["chr"],"align":["left"]},{"label":["records"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["n.max"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["n.start"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["events"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["rmean"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["rmean.std.error"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["median"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["conf.low"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["conf.high"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["nobs"],"name":[11],"type":["int"],"align":["right"]}],"data":[{"1":"trt=1","2":"69","3":"69","4":"69","5":"64","6":"123.9282","7":"14.84352","8":"103.0","9":"59","10":"132","11":"69"},{"1":"trt=2","2":"68","3":"68","4":"68","5":"64","6":"142.0613","7":"26.81071","8":"52.5","9":"44","10":"95","11":"68"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Alternatively, use <code>summary()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(veterans_fit)[[<span class="st">"table"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;       records n.max n.start events    rmean se(rmean) median 0.95LCL 0.95UCL
#&gt; trt=1      69    69      69     64 123.9282  14.84352  103.0      59     132
#&gt; trt=2      68    68      68     64 142.0613  26.81071   52.5      44      95</code></pre>
</div>
</div>

<!--
#### Length of follow-up

It probably isn't necessary to quantify length of follow-up, see rufibachetal_QuantificationFollowupTime_2022

> One measure of the quality of a clinical trial is the duration of follow-up, as measured by the median follow-up time. This is a measure that captures how long, on average, patients have been followed.

> Time-to-event studies must have sufficiently long follow-up durations to capture enough events to reveal meaningful patterns in the data. https://en.wikipedia.org/wiki/Median_follow-up

> Time to event studies must have sufficient follow-up to capture enough events and thereby ensure there is sufficient power to perform appropriate statistical tests. The proposed length of followup for a prospective study will be based primarily on the severity of the disease or prognosis of the participants.

The median follow-up time can be obtained using the **reverse Kaplan-Meier method**, wherein the censoring status indicators are reversed (0 = no, 1 = yes) before estimating the survival function. Here the target event is now interpreted as censored in the sense that a person's observation time could have been longer had they not experienced the target event, and the survival estimates are now interpreted as the percent of the sample that have either had the event or remained under observation at time $t$.

The median follow-up time can be obtained using the **reverse Kaplan-Meier method**, wherein the censoring status indicators are reversed (0 = no, 1 = yes) before estimating the survival function. Here the target event is now interpreted as censored in the sense that a person's observation time could have been longer had they not experienced the target event, and the survival estimates are now interpreted as the percent of the sample being followed at time $t$.



::: {.cell}

```{.r .cell-code}
veterans_fu_fit <- survfit(Surv(time, 1 - status) ~ 1, data = veteran)
```
:::


The median follow-up time is then simply the median survival time of this model:


::: {.cell}

```{.r .cell-code}
glance(veterans_fu_fit)
```

::: {.cell-output-display}

`````{=html}
<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":["records"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["n.max"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["n.start"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["events"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["rmean"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["rmean.std.error"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["median"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["conf.low"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["conf.high"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["nobs"],"name":[10],"type":["int"],"align":["right"]}],"data":[{"1":"137","2":"137","3":"137","4":"9","5":"838.8409","6":"52.42938","7":"NA","8":"NA","9":"NA","10":"137"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
`````

:::
:::


However, as is the case here, this has the drawback that the median follow-up time will be undefined (`NA`) if 50% of the sample had not been followed at the time of study end.

the survival curve never crosses the 0.5 line.


::: {.cell}

```{.r .cell-code}
ggplot(tidy(survfit0(veterans_fu_fit)), aes(x = time, y = estimate)) +
  geom_step() +
  geom_hline(yintercept = 0.5, linetype = 2) +
  coord_cartesian(ylim = c(0, 1))
```

::: {.cell-output-display}
![](index_files/figure-html/unnamed-chunk-25-1.png){width=672}
:::
:::


A simpler approach is to find the median of all survival times, whether censored or not; however in studies with many early events, but a long observation period, this can give the appearance of a short median follow-up time.


::: {.cell}

```{.r .cell-code}
quantile(veteran$time)
```

::: {.cell-output .cell-output-stdout}
```
#>   0%  25%  50%  75% 100% 
#>    1   25   80  144  999
```
:::
:::


In this data set the median is defined:


::: {.cell}

```{.r .cell-code}
quantile(lung$time)
```

::: {.cell-output .cell-output-stdout}
```
#>      0%     25%     50%     75%    100% 
#>    5.00  166.75  255.50  396.50 1022.00
```
:::

```{.r .cell-code}
survfit(Surv(time, abs(status - 2)) ~ 1, data = lung) |>
  quantile()
```

::: {.cell-output .cell-output-stdout}
```
#> $quantile
#>  25  50  75 
#> 301 588 965 
#> 
#> $lower
#>  25  50  75 
#> 272 511 821 
#> 
#> $upper
#>   25   50   75 
#>  404 1010   NA
```
:::
:::

-->


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/tidytales\.ca/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<script src="https://giscus.app/client.js" data-repo="mccarthy-m-g/tidytales" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzI2MTI0NjU=" data-category="Comments" data-category-id="DIC_kwDOFjWdcc4CSRY9" data-mapping="title" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../../series/2023-02-24_frequentist-statistics-labs/posts/01_probability-distributions/index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Probability distributions</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Survival Analysis</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> Time to events.</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="an">order:</span><span class="co"> 99</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">## Recommended Reading</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Applied Survival Analysis Using R</span><span class="co">](http://link.springer.com/10.1007/978-3-319-31245-3)</span> by Dirk F. Moore</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Chapters 9 to 15 in <span class="co">[</span><span class="ot">Applied Longitudinal Data Analysis: Modeling Change and Event Occurrence</span><span class="co">](https://doi.org/10.1093/acprof:oso/9780195152968.001.0001)</span> by Judith Singer and John Willett</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">A package for survival analysis in R</span><span class="co">](https://cran.r-project.org/web/packages/survival/vignettes/survival.pdf)</span> by Terry Therneau</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prerequisites</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(asaur)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Survival analysis is the study of survival times and of the factors that influence them.</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="fu">### Censoring</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>There are X types of censoring:</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Left censoring</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Right censoring</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>id, <span class="sc">~</span>time, <span class="sc">~</span>event, <span class="sc">~</span>censored,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p1"</span>, <span class="dv">0</span>, <span class="st">"0"</span>, <span class="cn">FALSE</span>,</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p1"</span>, <span class="dv">7</span>, <span class="st">"1"</span>, <span class="cn">TRUE</span>,</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p2"</span>, <span class="dv">0</span>, <span class="st">"0"</span>, <span class="cn">FALSE</span>,</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"p2"</span>, <span class="dv">6</span>, <span class="st">"2"</span>, <span class="cn">FALSE</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> id)) <span class="sc">+</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> event, <span class="at">fill =</span> censored), <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">16</span>, <span class="dv">21</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"white"</span>)) <span class="sc">+</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>)</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>Censoring mechanisms can be classified into three types:</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Type I: censoring times are pre-specified.</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Type II: censoring occurs when a prespecified fraction of observations have failed.</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Random: censoring occurs randomly.</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hazard and Survival functions</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Survival analysis methods depend on the survival distribution, and two key ways of specifying it are the survival function and the hazard function.</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Survival function: the probability of surviving up to a point $t$.</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Hazard function: the instantaneous failure rate.</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>Survival distributions can also be represented with:</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cumulative risk function: the probability of surviving on or before a point $t$.</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cumulative hazard function: the area under the hazard function up to time $t$.</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>Survival functions are typically estimated with nonparametric methods:</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Kaplan-Meier estimator</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Nelson-Altschuler estimator</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## RCT: Veterans' Administration Lung Cancer study</span></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>Veterans' Administration Lung Cancer study is a standard randomized clinical trial investigating the effect of a standard or test chemotherapy on time to death in <span class="in">`r nrow(veteran)`</span> males with advanced inoperable lung cancer. The data for this trial comes from kalbfleischprentice_StatisticalAnalysisFailure_2002 and is included in the survival package as <span class="in">`veteran`</span>. The following variables were recorded at intake:</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`trt`</span>:    Chemotherapy treatment type (1 = standard, 2 = test)</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`celltype`</span>: Histological tumour type (1 = squamous, 2 = smallcell, 3 = adeno, 4 = large)</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`karno`</span>: General medical status measured with the Karnofsky performance score (10-30 = completely hospitalized, 40-60 = partial confinement, 70-90 = able to care for self)</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`diagtime`</span>: Time in months from diagnosis to randomization</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`age`</span>: Age in years</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`prior`</span>: Prior therapy (0 = no, 10 = yes)</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>Survival was recorded as:</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`time`</span>: Survival time in days</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`status`</span>: Censoring status (0 = yes, 1 = no)</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>We can get a glimpse of the data with <span class="in">`dplyr::glimpse()`</span>:</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veteran)</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exploratory data analysis</span></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>Rather than working with the raw data, we begin by estimating the survival function of the <span class="in">`veteran`</span> data using the **Kaplan-Meier estimator**. We accomplish this with <span class="in">`survival::survfit()`</span>, which estimates a survival curve for censored data using R's formula syntax. The response variable is a <span class="in">`Surv`</span> object created with <span class="in">`survival::Surv()`</span>, which tracks survival time and censoring; the predictor is <span class="in">`1`</span>, which indicates this is an intercept-only model.</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>To use alternative estimators for the survival function, specify the optional <span class="in">`stype`</span> and <span class="in">`ctype`</span> arguments in <span class="in">`survival::survfit()`</span>. For the Nelson-Aalen estimator (aka Nelson-Altschuler or Fleming-Harrington) use <span class="in">`survfit(..., stype = 2, ctype = 1)`</span>; for the "fh2" estimator use <span class="in">`survfit(..., stype = 2, ctype = 2)`</span>. The default Kaplan-Meier estimator is equivalent to <span class="in">`survfit(..., stype = 1, ctype = 1)`</span>.</span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>veterans_km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> veteran)</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>Although we are interested in the survival function of the <span class="in">`veteran`</span> data, the actual reason we began this way is because it provides a convenient method for transforming the raw data into a format better suited for some initial exploratory data analysis. We first add a time 0 to the <span class="in">`survfit`</span> object with <span class="in">`survival::survfit0()`</span> (otherwise the data will start at the first observation time) then get the transformed data with <span class="in">`broom::tidy()`</span>:</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_tidy <span class="ot">&lt;-</span> veterans_km_fit <span class="sc">|&gt;</span></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit0</span>() <span class="sc">|&gt;</span></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_km_fit_tidy)</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>This summary of the <span class="in">`veteran`</span> data, called a **life table** <span class="co">[</span><span class="ot">see Section 10.1 in singerwillett_AppliedLongitudinalData_2003</span><span class="co">]</span>, tracks the event histories (the "lives") of the sample from the beginning of time (when no one has experienced the target event) to the end of data collection (when everyone has either experienced the target event or been censored). For now we are only interested in first four variables, which we can use to explore event occurrence over time:</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`time`</span>: the time point, $t$</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`n.risk`</span>: the number of males at risk at time $t$</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`n.event`</span>: the number of events that occurred at time $t$</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`n.censor`</span>:   the number of males who exited the risk set, without an event, at time $t$</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>There are two ways to visualize this data: First, we can explore how the risk set changes over time, and second, we can explore what events occurred at each time $t$. Additionally, these visualizations can either be stepped or not; we'll visualize both versions for completeness sake.</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Event history</span></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>We'll start by exploring how the risk set changes over time. This requires further transformation of the data to (1) get the appropriate counts at each time point, (2) pivot to a tidier format, and (3) create steps for each time point.</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>veterans_risk_set <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (1) Get the appropriate counts at each time point.</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">alive =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">dead =</span> <span class="fu">cumsum</span>(n.event),</span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">cumsum</span>(n.censor)</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, alive, dead, censored) <span class="sc">|&gt;</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (2) Pivot to a tidier format.</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"status"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"dead"</span>, <span class="st">"alive"</span>)))</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_risk_set)</span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a><span class="co"># (3) Create steps for each time point.</span></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>veterans_risk_set_stepped <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">alive =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">died =</span> alive <span class="sc">+</span> <span class="fu">cumsum</span>(n.event),</span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> died <span class="sc">+</span> <span class="fu">cumsum</span>(n.censor)</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, alive, died, censored) <span class="sc">|&gt;</span></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"status"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"died"</span>, <span class="st">"alive"</span>)))</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on: https://stackoverflow.com/a/41962072/16844576</span></span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>veterans_risk_set_stepped <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw =</span> veterans_risk_set_stepped,</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="fu">mutate</span>(veterans_risk_set_stepped, <span class="at">n =</span> <span class="fu">lag</span>(n, <span class="fu">nlevels</span>(status))),</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"source"</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(time, <span class="fu">desc</span>(source))</span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_risk_set_stepped)</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>@fig-veteran-risk-set depicts how the risk set of the <span class="in">`veteran`</span> data changed over time. This is a standard event history for survival data...</span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>The advantage of the stepped version is that it makes it easier to see when events occurred. It also matches the survival curve plots we'll create later, which are all visualized with step functions. The disadvantage is that it involves more code. If this was going to be reported to others I would use the stepped version, but for personal exploration I would use the not stepped version.</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-veteran-risk-set</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: |</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a><span class="co">#|   Event history of the `veteran` data, depicting how the risk set changes</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="co">#|   over time.</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Not stepped"</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Stepped"</span></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_risk_set, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> status)) <span class="sc">+</span></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_risk_set_stepped, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> status)) <span class="sc">+</span></span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> n)) <span class="sc">+</span></span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>As a compliment to @fig-veteran-risk-set, we can also explore what events occurred at each time $t$. @fig-veteran-events depicts the event history of the <span class="in">`veteran`</span> data over time---this is essentially a more information rich version of <span class="co">[</span><span class="ot">risk tables</span><span class="co">](http://www.danieldsjoberg.com/ggsurvfit/reference/add_risktable.html)</span> that are sometimes appended to survival curve plots.</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>The code for this is nearly identical to the code for the previous plots---the main difference is how we calculate the counts at each time point---so I've folded it here.</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-veteran-events</span></span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: |</span></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a><span class="co">#|   Event history of the `veteran` data, depicting what events occurred at each</span></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a><span class="co">#|   time $t$.</span></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Not stepped"</span></span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Stepped"</span></span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>veterans_events <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (1) Get the appropriate counts at each time point. Now we use the raw counts</span></span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rather than cumulative sums.</span></span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">none =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">died =</span> n.event,</span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> n.censor</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, none, died, censored) <span class="sc">|&gt;</span></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (2) Pivot to a tidier format.</span></span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"event"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">factor</span>(event, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"died"</span>, <span class="st">"none"</span>)))</span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a><span class="co"># (3) Create steps for each time point.</span></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>veterans_events_stepped <span class="ot">&lt;-</span> veterans_km_fit_tidy <span class="sc">|&gt;</span></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">none =</span> n.risk <span class="sc">-</span> n.event <span class="sc">-</span> n.censor,</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>    <span class="at">died =</span> none <span class="sc">+</span> n.event,</span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> died <span class="sc">+</span> n.censor</span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, none, died, censored) <span class="sc">|&gt;</span></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"event"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">factor</span>(event, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"censored"</span>, <span class="st">"died"</span>, <span class="st">"none"</span>)))</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>veterans_events_stepped <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw =</span> veterans_events_stepped,</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="fu">mutate</span>(veterans_events_stepped, <span class="at">n =</span> <span class="fu">lag</span>(n, <span class="fu">nlevels</span>(event))),</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"source"</span></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(time, <span class="fu">desc</span>(source))</span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_events, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> event)) <span class="sc">+</span></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(veterans_events_stepped, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> n, <span class="at">fill =</span> event)) <span class="sc">+</span></span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> n)) <span class="sc">+</span></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#1b6ca8"</span>, <span class="st">"#cd201f"</span>, <span class="st">"#3aaf85"</span>))</span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Survival curves</span></span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a>Now we're ready to explore the Kaplan-Meier estimates of the survival probability over time. First, let's look at the life table data again:</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_km_fit_tidy)</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>The last four variables, which we skipped over earlier, are the Kaplan-Meier estimates of the survival probability over time:</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`estimate`</span>: Estimate of the survival function, the probability of surviving up to time $t$</span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`std.error`</span>: The standard error of the regression term</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`conf.high`</span>: Upper bound on the pointwise confidence interval for the estimate</span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`conf.low`</span>: Lower bound on the pointwise confidence interval for the estimate</span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>These estimates and their intervals can be plotted as a **survival curve**:</span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_tidy,</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high)</span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>)</span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a>To better visualize uncertainty about our estimates, we can plot multiple intervals of different widths. To do this we first create a small helper function, <span class="in">`dist_tidy()`</span>, to get multiple intervals from a survival model with additional <span class="in">`.width`</span> and <span class="in">`level`</span> columns for compatibility with <span class="in">`ggdist::geom_lineribbon()`</span>:</span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a>dist_tidy <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">conf.type =</span> <span class="st">"log-log"</span>, <span class="at">conf.int =</span> <span class="fl">0.95</span>, ...) {</span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map_df</span>(</span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">set_names</span>(conf.int),</span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(.x) broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="fu">update</span>(x, <span class="at">conf.type =</span> conf.type, <span class="at">conf.int =</span> .x)),</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">.id =</span> <span class="st">".width"</span></span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggdist automatically pulls from the .width column of summarized data to</span></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot multiple intervals. The width column should be numeric for this to</span></span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>    <span class="co"># work correctly.</span></span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">.width =</span> <span class="fu">as.numeric</span>(.width),</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggdist turns .width into level internally with its stat_ geoms, but for</span></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_ geoms we need to do this in the summary data. This is mainly for</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ease of use with the fill_ramp aesthetic.</span></span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">level  =</span> <span class="fu">factor</span>(.width, <span class="at">levels =</span> <span class="fu">sort</span>(conf.int, <span class="at">decreasing =</span> <span class="cn">TRUE</span>))</span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(.width, level, <span class="at">.after =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The last time always has NAs for the CIs and it's important to remove this;</span></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>  <span class="co"># otherwise the fills in ggdist::geom_lineribbon() will plot incorrectly.</span></span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>Then we can plot the survival curve with multiple intervals (here 66% and 95%) using the data tidied with <span class="in">`dist_tidy()`</span>:</span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-veteran-km-curve</span></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Kaplan-Meier survival curve with 66% and 95% intervals</span></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_dist <span class="ot">&lt;-</span> <span class="fu">dist_tidy</span>(veterans_km_fit, <span class="at">conf.int =</span> <span class="fu">c</span>(<span class="fl">0.66</span>, <span class="fl">0.95</span>))</span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_dist,</span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high)</span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>()</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a>p_veterans_km</span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a>It may also be desirable to add additional info to the survival curve plot, like when censoring occurred. A non-invasive way to do this is to add a rug of censored times to the x-axis. A more common approach is to add points directly on the survival curve where censored events occurred. These points are often plotted as black "+" signs, which can be hard to see; here I plot them as red points instead.</span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-veteran-censored</span></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: |</span></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="co">#|   Censoring times in the `veteran` data.</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Rug"</span></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Points"</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a><span class="co"># To add censoring information to the plot we need a data frame containing only</span></span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a><span class="co"># the censored observations.</span></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_tidy_censored <span class="ot">&lt;-</span></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(veterans_km_fit_tidy, n.censor <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a><span class="co"># With a rug</span></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="sc">+</span></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rug</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="cn">NULL</span>), <span class="at">data =</span> veterans_km_fit_tidy_censored)</span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a><span class="co"># With points</span></span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="sc">+</span></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_tidy_censored,</span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"red"</span></span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>Along with the life table data, which we use to plot the survival curve, the <span class="in">`survfit`</span> object stores the following summary statistics:</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`records`</span>: Number of observations</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`n.max`</span>: Maximum number of subjects at risk</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`n.start`</span>: Initial number of subjects at risk</span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`events`</span>: Number of events</span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`rmean`</span>: Restricted mean survival</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`rmean.std.error`</span>: Restricted mean standard error</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`median`</span>: Median survival</span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`conf.low`</span>: Lower end of confidence interval on median</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`conf.high`</span>: Upper end of confidence interval on median</span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`nobs`</span>: Number of observations used</span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a>They can be retrieved with <span class="in">`broom::glance()`</span>:</span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>The method used to resolve the restricted mean survival estimate when the last observation is not a death can be set with the optional <span class="in">`rmean`</span> argument in <span class="in">`broom::glance()`</span>. For details, see <span class="in">`?survival::print.survfit`</span> and <span class="in">`?broom::glance.survfit`</span>.</span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>veterans_km_fit_summary <span class="ot">&lt;-</span> <span class="fu">glance</span>(veterans_km_fit)</span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veterans_km_fit_summary)</span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a>These summary statistics can be included in the survival curve plot as well. For example, the **median survival time**:</span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a>p_veterans_km <span class="sc">+</span></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">xend =</span> conf.high, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">yend =</span> <span class="fl">0.5</span>),</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_summary,</span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(</span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="fl">0.5</span>),</span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_summary,</span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> median, <span class="at">xend =</span> median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> <span class="fl">0.5</span>),</span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> veterans_km_fit_summary,</span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Cumulative risk (incidence) curves</span></span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a>The **cumulative risk** (aka cumulative incidence) at a time point is simply one minus the survival probability:</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a>p_veterans_risk <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_dist,</span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> <span class="dv">1</span> <span class="sc">-</span> estimate, <span class="at">ymin =</span> <span class="dv">1</span> <span class="sc">-</span> conf.low, <span class="at">ymax =</span> <span class="dv">1</span> <span class="sc">-</span> conf.high)</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>()</span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a>p_veterans_risk</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Cumulative hazard curves</span></span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a>The cumulative hazard function can be estimated in two ways:</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the negative log survivor function method</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the Nelson-Aalen method</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a>In general both methods give similar estimates, particularly at early event times when the risk set is large. However, they tend to diverge as the size of the risk set decreases.</span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a>The negative log survivor function method involves transforming the Kaplan-Meier estimates of survival probability over time by taking their negative log. The resulting estimates of the cumulative hazard function are called **negative log survivor function estimates**.</span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>p_veterans_cumhaz <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>  veterans_km_fit_dist,</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log</span>(estimate), <span class="at">ymin =</span> <span class="sc">-</span><span class="fu">log</span>(conf.low), <span class="at">ymax =</span> <span class="sc">-</span><span class="fu">log</span>(conf.high))</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="at">step =</span> <span class="st">"vh"</span>) <span class="sc">+</span></span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>()</span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a>p_veterans_cumhaz</span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a>Estimates of the cumulative hazard function and their standard error using the Nelson-Aalen method are included in the <span class="in">`survfit`</span> object as <span class="in">`object$cumhaz`</span> and <span class="in">`object$std.chaz`</span>, respectively. No confidence intervals are returned, however.</span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Kernel smoothed hazard curves</span></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>The **muhaz** package provides a method for gettinng kernel smoothed estimates of the hazard function. The function API isn't great, so we wrap it in a small helper function to make things cleaner. No intervals are provided for these estimates.</span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(muhaz)</span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>haz_tidy <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(survival<span class="sc">::</span><span class="fu">survfit0</span>(x))</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>  haz <span class="ot">&lt;-</span> muhaz<span class="sc">::</span><span class="fu">muhaz</span>(</span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> x<span class="sc">$</span>time,</span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta =</span> x<span class="sc">$</span>n.censor,</span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.time =</span> <span class="fu">min</span>(x<span class="sc">$</span>time),</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fu">max</span>(x<span class="sc">$</span>time),</span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">bw.method =</span> <span class="st">"global"</span>,</span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">b.cor =</span> <span class="st">"none"</span>,</span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(haz)</span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">haz_tidy</span>(veterans_km_fit), <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a><span class="fu">### Statistical modelling</span></span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictive methods</span></span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multiple groups</span></span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a>TODO: Decide whether to have a single arm trial section AND a multi-group RCT section (mainly because there are some code differences between the two)</span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a>Multiple survival curves on one plot:</span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a>veterans_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt, <span class="at">data =</span> veteran)</span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a>veterans_fit_tidy <span class="ot">&lt;-</span> <span class="fu">dist_tidy</span>(veterans_fit, <span class="at">conf.int =</span> <span class="fu">c</span>(<span class="fl">0.66</span>, <span class="fl">0.95</span>))</span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a>  veterans_fit_tidy,</span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> strata)</span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lineribbon</span>(<span class="fu">aes</span>(<span class="at">fill_ramp =</span> level), <span class="at">step =</span> <span class="st">"hv"</span>)</span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a>This specific example might be better server with a faceted plot:</span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(strata), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a><span class="in">`glance()`</span> only supports models that can be summarized in a single row. We can refit the survival model to subsets as a workaround to get <span class="in">`glance()`</span> to work for multi-strata survival models:</span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a>veterans_fit_glance <span class="ot">&lt;-</span> <span class="fu">map_df</span>(</span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"trt=1"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"trt=2"</span> <span class="ot">=</span> <span class="dv">2</span>),</span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(.x) <span class="fu">glance</span>(<span class="fu">update</span>(veterans_fit, <span class="at">subset =</span> (trt <span class="sc">==</span> .x))),</span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"strata"</span></span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>veterans_fit_glance</span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>Alternatively, use <span class="in">`summary()`</span>:</span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(veterans_fit)[[<span class="st">"table"</span>]]</span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--</span></span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a><span class="co">#### Length of follow-up</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a><span class="co">It probably isn't necessary to quantify length of follow-up, see rufibachetal_QuantificationFollowupTime_2022</span></span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a><span class="co">&gt; One measure of the quality of a clinical trial is the duration of follow-up, as measured by the median follow-up time. This is a measure that captures how long, on average, patients have been followed.</span></span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a><span class="co">&gt; Time-to-event studies must have sufficiently long follow-up durations to capture enough events to reveal meaningful patterns in the data. https://en.wikipedia.org/wiki/Median_follow-up</span></span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a><span class="co">&gt; Time to event studies must have sufficient follow-up to capture enough events and thereby ensure there is sufficient power to perform appropriate statistical tests. The proposed length of followup for a prospective study will be based primarily on the severity of the disease or prognosis of the participants.</span></span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a><span class="co">The median follow-up time can be obtained using the **reverse Kaplan-Meier method**, wherein the censoring status indicators are reversed (0 = no, 1 = yes) before estimating the survival function. Here the target event is now interpreted as censored in the sense that a person's observation time could have been longer had they not experienced the target event, and the survival estimates are now interpreted as the percent of the sample that have either had the event or remained under observation at time $t$.</span></span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a><span class="co">The median follow-up time can be obtained using the **reverse Kaplan-Meier method**, wherein the censoring status indicators are reversed (0 = no, 1 = yes) before estimating the survival function. Here the target event is now interpreted as censored in the sense that a person's observation time could have been longer had they not experienced the target event, and the survival estimates are now interpreted as the percent of the sample being followed at time $t$.</span></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a><span class="co">veterans_fu_fit &lt;- survfit(Surv(time, 1 - status) ~ 1, data = veteran)</span></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a><span class="co">The median follow-up time is then simply the median survival time of this model:</span></span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a><span class="co">glance(veterans_fu_fit)</span></span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a><span class="co">However, as is the case here, this has the drawback that the median follow-up time will be undefined (`NA`) if 50% of the sample had not been followed at the time of study end.</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a><span class="co">the survival curve never crosses the 0.5 line.</span></span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a><span class="co">ggplot(tidy(survfit0(veterans_fu_fit)), aes(x = time, y = estimate)) +</span></span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a><span class="co">  geom_step() +</span></span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a><span class="co">  geom_hline(yintercept = 0.5, linetype = 2) +</span></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a><span class="co">  coord_cartesian(ylim = c(0, 1))</span></span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a><span class="co">A simpler approach is to find the median of all survival times, whether censored or not; however in studies with many early events, but a long observation period, this can give the appearance of a short median follow-up time.</span></span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a><span class="co">quantile(veteran$time)</span></span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a><span class="co">In this data set the median is defined:</span></span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a><span class="co">quantile(lung$time)</span></span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a><span class="co">survfit(Surv(time, abs(status - 2)) ~ 1, data = lung) |&gt;</span></span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a><span class="co">  quantile()</span></span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">© Copyright 2023 <a href="https://michaelmccarthy.tidytales.ca">Michael McCarthy</a></div>
  </div>
</footer>



</body></html>