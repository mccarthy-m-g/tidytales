---
draft: true
title: "Tales from the Borderlands"
description: |
  Post-processing plots with {magick}.
author:
  - name: Michael McCarthy 
    url: https://michaelmccarthy.netlify.app
    affiliation: Dahl Corporation
    #affiliation_url: https://example.com/spacelysprokets
date: "2021-03-16"
categories:
  - Data Visualization
  - "{ggplot2}"
  - "{magick}"
output:
  distill::distill_article:
    self_contained: false
    toc: true
---

```{r setup, include=FALSE}
# Ensure the project root is set up correctly using {here} --------------------
here::i_am("_posts/2021-03-16_borderlands/2021-03-16_borderlands.Rmd")

# Load general set up packages used in all posts ------------------------------
library(here)

# Load R scripts located in R/ ------------------------------------------------

# Set default options for knitr code chunks -----------------------------------
knitr::opts_chunk$set(comment = "#>",
                      echo = TRUE)

# Create templates for knitr code chunks --------------------------------------
knitr::opts_template$set(
  fig.graphic = list(echo = FALSE),
  no.message = list(message = FALSE, warning = FALSE)
)
```

```{r meta, include=FALSE, results='asis'}
library(metathis)

meta() %>%
  meta_social(
    title = "Tidy Tales: ...",
    url = "https://tidytales.ca/posts/yyyy-mm-dd_post-name/",
    image = "https://tidytales.ca/posts/yyyy-mm-dd_post-name/images/post-name_card.png",
    image_alt = "Hero image of plot and Tidy Tales logo",
    image_width = 1200,
    image_height = 628,
    og_type = "article",
    twitter_card_type = "summary_large_image",
  )
```

## Overview

Borderlands is a an action role-playing first-person looter shooter video game franchise set in a space western science-fiction universe. The games have a dramatic comic book art style that I want to capture in my plot.

<!-- ------------------------------------------------------------------------------------------ -->
(ref:borderlands-screenshot) In-game screenshot from Borderlands 3.

```{r borderlands-screenshot, opts.label='fig.graphic', fig.cap="(ref:borderlands-screenshot)"}
knitr::include_graphics(here("_posts",
                             "2021-03-16_borderlands",
                             "figures",
                             "borderlands-screenshot.jpeg")
                        )
```

Gearbox, the developers of Borderlands, [have explained](https://www.vg247.com/2009/04/16/borderlands-art-process-explained/) that this art style is achieved using "hand-drawn textures, scanned in and coloured in Photoshop, combined with software that draws graphic novel-style outlines around characters and objects, sharpens shadows to look more like something an artist might create, and even draws lines on hills and inclines. Finally the character models are all revamped with more exaggerated proportions, creating the appearance of a detailed comic book in motion."

Some of these are not relevant to plotting, but two are:

- Drawing graphic novel-style outlines
- Using hand-drawn textures

### Theming Inspiration

The in-game menus in Borderlands 3 provide a great design reference for plot theming.

<!-- ------------------------------------------------------------------------------------------ -->
(ref:echo-menu) The ECHO-3 in-game menu in Borderlands 3.

```{r echo-menu, opts.label='fig.graphic', fig.cap="(ref:echo-menu)"}
knitr::include_graphics(here("_posts",
                             "2021-03-16_borderlands",
                             "figures",
                             "echo-menu.jpeg")
                        )
```

<aside>
<!-- ------------------------------------------------------------------------------------------ -->
(ref:loot-rarity) Loot in Borderlands (guns, grenades, shields, etc.) are colour categorized by the rarity with which they can be found in containers or dropped by defeated enemies. From left to right the categories are: Common, Uncommon, Rare, Epic, Legendary.

```{r loot-rarity, opts.label='fig.graphic', fig.cap="(ref:loot-rarity)"}
knitr::include_graphics(here("_posts",
                             "2021-03-16_borderlands",
                             "figures",
                             "loot-rarity.png")
                        )
```
</aside>

I want to translate these design elements to my plot like so:

- The [Compacta Bold](https://fontsempire.com/font/borderlands-font/) font can be used for plot text.
- The blue background and light blue UI highlights can be used for the plot background and axes, respectively.
- The white header text can be used for the plot title, and the blue text can be used for other textual elements of the plot.
- The loot rarity colours can be used for grouping data in plot geoms.

Applying these elements to my plot will help it fit the Borderlands aesthetic.

## R

```{r requirements-setup}
library(tidyverse)
library(glue)
library(lubridate)
library(magick)
```

I'll be using Steam player data for my plot. The data contains statistics for the average and peak number of players playing a variety of games each month from July 2012 to February 2021. You can [download this data](#data-source) with the Data Source code in the appendix.

```{r load-data}
# Load the weekly data
games <- read_csv(here("data", "2021-03-16_games.csv"))
games
```

### Wrangle

I only want data from the mainline Borderlands titles for my plot, so let's get those.

```{r}
# Filter to mainline Borderlands titles available in the data. The first game
# is not available in the dataset so filtering based on the title and digit
# works fine here.
borderlands <- games %>%
  filter(str_detect(gamename, "Borderlands[[:space:]][[:digit:]]"))

borderlands
```

Now to explore the data.

```{r}
# Summarize how much data exists for each Borderlands title
borderlands %>%
  group_by(gamename) %>%
  summarise(count = n())
```

Borderlands 2 was released on Steam in September 2012 and Borderlands 3 was released in March 2020, which explains the discrepancy in how much data exists between the two. One way to make them more comparable is to filter the Borderlands 2 data down to only its first year of release.

```{r}
# Wrangle date data into a date-time object to prepare for filtering
borderlands <- borderlands %>%
  mutate(date = glue("{year}-{month}"),
         date = parse_date_time(date, "ym"),
         .after = gamename)

# Filter Borderlands 2 data down to only its first year of release to make
# comparisons with Borderlands 3 more appropriate. There is no need to filter
# by date for Borderlands 3 since only its first year of data are available in
# the dataset.
borderlands <- borderlands %>%
  filter(gamename == "Borderlands 2" &
         date %within% interval(ymd("2012--09-01"), ymd("2013--08-01")) |
         gamename == "Borderlands 3") 

borderlands
```

Now there is monthly data for the first year of release for each game. I want to compare how the two games performed against each other in their first year. This will give some insight on how the player stats changed over time within and between the games. Creating a new variable counting the number of months since release is a clean way to do this. I could also stick with nominal months, but using a count variable will make the comparison between the games more apparent in my plot.

```{r}
# This code is sufficient since the data is in reverse chronological order.
borderlands <- borderlands %>%
  group_by(gamename) %>%
  mutate(since_release = 11:0, .after = month)

borderlands
```

Finally, I need to decide how to relate the five rarity colours from Figure\ \@ref(fig:loot-rarity) to the player stats for the first year of release for each game. Assigning each month a colour based on its performance relative to other months 

```{r}
# these can be used as cutoffs for colouring bars
borderlands %>%
  group_by(gamename) %>%
  summarise(quantile = quantile(peak))

borderlands <- borderlands %>%
  mutate(rarity = case_when(
    between(peak, 0, 19999) ~ "white",
    between(peak, 20000, 39999) ~ "green",
    between(peak, 40000, 59999) ~ "blue",
    between(peak, 60000, 79999) ~ "purple",
    between(peak, 80000, 150000) ~ "orange"
  ))
```

### Visualize

There are two obvious ways to visualize this data: A time series line graph, or a bar graph. I'm going to use a bar graph, mainly so I can group the bars using the loot rarity colours I mentioned earlier. 

```{r}
light_blue <- "#23f7fe"
blue <- "#00378f"
dark_blue <- "#091d31"
indigo <- "#003b4a"

ggplot(borderlands, aes(since_release, peak)) +
  geom_col(fill = light_blue) +
  facet_wrap(vars(gamename)) +
  labs(x = "Month Since Release",
       y = "Peak Player Count",
       title = "Borderlands Peak Players",
       subtitle = "Data from Steam",
       caption = "Data Source: TidyTuesday") +
  theme(text = element_text(family = "sans", colour = light_blue),
        # Axis
        axis.title = element_text(color = light_blue),
        axis.text = element_text(colour = light_blue),
        axis.line = element_line(colour = light_blue, lineend = "square", size = .75),
        axis.ticks = element_line(colour = light_blue, size = .75),
        axis.ticks.length = unit(10, "pt"),
        # Panel
        panel.background = element_rect(colour = indigo, fill = dark_blue),
        panel.grid = element_line(colour = indigo),
        panel.grid.minor = element_line(colour = "transparent"),
        # Plot
        plot.title = element_text(face = "bold", color = "white"),
        plot.subtitle = element_text(color = "white"),
        plot.caption = element_text(colour = "white"),
        plot.background = element_rect(fill = "black"),
        # Strip
        strip.text = element_text(colour = light_blue),
        strip.background = element_rect(colour = light_blue, fill = indigo, size = 1.5))

```

light blue
	

blue
0	55	143	

```{r}
# Produce image using graphics device
# TODO: Add kerning to letters with {hrbragg} if I can resolve install error
fig <- image_graph(width = 800, height = 800, res = 320)
ggplot(borderlands, aes(since_release, peak)) +
  geom_col(fill = light_blue) +
  facet_wrap(vars(gamename)) +
  labs(x = "Month Since Release",
       y = "Peak Player Count",
       title = "Borderlands Peak Players",
       subtitle = "Data from Steam",
       caption = "Data Source: TidyTuesday") +
  theme(text = element_text(family = "sans", colour = light_blue),
        # Axis
        axis.title = element_text(color = light_blue),
        axis.text = element_text(colour = light_blue),
        axis.line = element_line(colour = light_blue, lineend = "square", size = .75),
        axis.ticks = element_line(colour = light_blue, size = .75),
        axis.ticks.length = unit(10, "pt"),
        # Panel
        panel.background = element_rect(colour = indigo, fill = dark_blue),
        panel.grid = element_line(colour = indigo),
        panel.grid.minor = element_line(colour = "transparent"),
        # Plot
        plot.title = element_text(face = "bold", color = "white"),
        plot.subtitle = element_text(color = "white"),
        plot.caption = element_text(colour = "white"),
        plot.background = element_rect(fill = "black"),
        # Strip
        strip.text = element_text(colour = light_blue),
        strip.background = element_rect(colour = light_blue, fill = indigo, size = 1.5))
dev.off()
```

```{r}
background_col <- "white"
text_col <- "black"
  
test_fig <- image_blank(500, 500, color = background_col) %>%
  image_annotate("Borderlands",
                 size = 70,
                 color = text_col,
                 location = "+100+50") 

test_fig_trans <- image_transparent(test_fig, background_col)

test_fig_edge <- test_fig %>%
  image_negate() %>%
  image_morphology('EdgeOut', "Diamond", iterations = 2)

image_flatten(c(test_fig_edge, test_fig_trans)) %>%
  image_negate()
```

```{r}
# Create plot used for the outline
file <- tempfile(fileext = '.png')
ragg::agg_png(file, width = 300, height = 220, res = 300, units = "mm", pointsize = 6)
ggplot(borderlands, aes(since_release, peak)) +
  geom_col(fill = "white") +
  facet_wrap(vars(gamename)) +
  labs(x = "Month Since Release",
       y = "Peak Player Count",
       title = "Borderlands Peak Players",
       subtitle = "Data from Steam",
       caption = "Data Source: TidyTuesday") +
  theme_bw() +
  theme(text = element_text(family = "Compacta Bold", colour = "black"),
        # Axis
        axis.title = element_text(size = 36),
        axis.text = element_text(size = 28, colour = "black"),
        axis.text.x = element_text(margin = margin(5, 0, 5, 0, "pt")),
        axis.text.y = element_text(margin = margin(0, 5, 0, 5, "pt")),
        axis.line = element_line(size = 0),
        axis.ticks = element_line(size = 2),
        axis.ticks.length = unit(10, "pt"),
        # Panel
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_rect(size = 0),
        panel.background = element_rect(colour = "black", size = 5),
        panel.spacing = unit(3, "lines"),
        # Plot
        plot.title = element_text(size = 72),
        plot.subtitle = element_text(size = 56),
        plot.margin = unit(c(40, 40, 40, 40), "pt"),
        # Strip
        strip.text = element_text(size = 36, margin = margin(0.5,0,0.5,0, "cm")),
        strip.background = element_rect(fill = "white", size = 5),
        # Caption
        plot.caption = element_text(size = 24))
dev.off()

plot_outline_layer <- image_read(file) %>%
  image_convert(type="Grayscale") %>%
  image_negate() %>%
  image_threshold("white", "5%") %>%
  image_morphology('EdgeOut', "Diamond", iterations = 12) %>%
  image_morphology('Dilate', "Diamond", iterations = 1) %>%
  image_negate() %>%
  image_transparent("white", fuzz = 7)

image_flatten(c(image_blank(3543, 2598, color = "red"), plot_outline_layer))
```


```{r}
blue <- "#08283c"
light_blue <- "#115190"
baby_blue <- "#a7e5ff"
indigo <- "#cef8ff"
  
plot_fill <- tempfile(fileext = '.png')
ragg::agg_png(plot_fill, width = 300, height = 220, res = 300, units = "mm", pointsize = 6)
ggplot(borderlands, aes(since_release, peak, fill = rarity)) +
  geom_col(colour = "black", size = 2) +
  scale_fill_identity() +
  facet_wrap(vars(gamename)) +
  guides(fill=FALSE) +
  labs(x = "Month Since Release",
       y = "Peak Player Count",
       title = "Borderlands Peak Players",
       subtitle = "Data from Steam",
       caption = "Data Source: TidyTuesday") +
  theme_bw() +
  theme(text = element_text(family = "Compacta Bold", colour = "white"),
        # Axis
        axis.title = element_text(size = 36),
        axis.text = element_text(size = 28, colour = indigo),
        axis.text.x = element_text(margin = margin(5, 0, 5, 0, "pt")),
        axis.text.y = element_text(margin = margin(0, 5, 0, 5, "pt")),
        axis.line = element_line(size = 0),
        axis.ticks = element_line(size = 2, colour = light_blue),
        axis.ticks.length = unit(10, "pt"),
        # Panel
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_rect(size = 0),
        panel.background = element_rect(fill = blue, colour = light_blue, size = 5),
        panel.spacing = unit(3, "lines"),
        # Plot
        plot.title = element_text(size = 72),
        plot.subtitle = element_text(size = 56),
        plot.margin = unit(c(40, 40, 40, 40), "pt"),
        plot.background = element_rect(fill = "#00378f"),
        # Strip
        strip.text = element_text(size = 36, margin = margin(0.5,0,0.5,0, "cm"), colour = baby_blue),
        strip.background = element_rect(fill = blue, colour = light_blue, size = 5),
        # Caption
        plot.caption = element_text(size = 24))
dev.off()

image_flatten(c(image_read(plot_fill), plot_outline_layer)) %>%
  image_despeckle()

image_composite(image_read(plot_fill), plot_outline_layer)

  # image_resize("600x") %>%
  # image_fill("skyblue", "+108+250", fuzz=25, refcolor = "white")

#image_read(plot_fill)

#image_canny("1x5+15%+30%") %>%
  #image_edge(5) # does nothing?
  #image_morphology('EdgeOut', "Diamond", iterations = 1) %>%
  #image_morphology("Close", "Diamond", iterations = 1)

#image_composite(image_read(plot_fill), plot_outline_layer, operator = "CopyOpacity")
```


```{r}
# Post-process
# fig %>%
#   image_convert(type="Grayscale") %>%
#   image_canny("1x2+15%+30%") %>%
#   image_morphology('EdgeOut', "Diamond", iterations = 3) %>%
#   image_negate() %>%
#   image_fill("red", "+370+250", fuzz=25, refcolor = "white")

```

## Data Source {.appendix}

Download the data used in this article with `tidytuesdayR::tt_load("2021-03-16")`.

## Fair Dealing {.appendix}

Any of the trademarks, service marks, collective marks, design rights or similar rights that are mentioned, used, or cited in this article are the property of their respective owners. They are used here as fair dealing for the purpose of education in accordance with [section 29 of the Copyright Act](https://laws-lois.justice.gc.ca/eng/acts/c-42/page-8.html#h-103270) and do not infringe copyright.
